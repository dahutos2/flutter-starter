<!DOCTYPE html><html><head>
      <title>uc01</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
.markdown-preview.markdown-preview {
  /*//////////////////////////////////////////////*/
  /* tags */
  /*//////////////////////////////////////////////*/
  /*//////////////////////////////////////////////*/
  /* list */
  /*//////////////////////////////////////////////*/
  /* arrow */
  /* check */
  /* ol */
  /*//////////////////////////////////////////////*/
  /* table */
  /*//////////////////////////////////////////////*/
  /* stripe */
  /* dark th */
  /*//////////////////////////////////////////////*/
  /* box */
  /*//////////////////////////////////////////////*/
}
.markdown-preview.markdown-preview h1 {
  padding: 0.4em 0.5em;
  /*文字の上下 左右の余白*/
  color: #494949;
  /*文字色*/
  background: #f4f4f4;
  /*背景色*/
  border-left: solid 5px #7db4e6;
  /*左線*/
  border-bottom: solid 3px #d7d7d7;
  /*下線*/
}
.markdown-preview.markdown-preview h2 {
  position: relative;
  padding: 0.5em;
  background: #7db4e6;
  color: white;
}
.markdown-preview.markdown-preview h2::before {
  position: absolute;
  content: '';
  top: 100%;
  left: 0;
  border: none;
  border-bottom: solid 15px transparent;
  border-right: solid 20px #959e9b;
}
.markdown-preview.markdown-preview h3 {
  font-size: 22px;
  font-weight: bold;
  border-bottom: 3px solid #33ad9d;
  margin: 40px 0 10px;
}
.markdown-preview.markdown-preview h4 {
  font-size: 18px;
  font-weight: bold;
  border-left: 3px solid #33ad9d;
  margin: 40px 0 10px;
  padding: 0 0 0 10px;
}
.markdown-preview.markdown-preview h5 {
  font-size: 16px;
  margin: 40px 0 10px;
  font-weight: bold;
}
.markdown-preview.markdown-preview hr {
  height: 1px;
  background-color: #b8bfbe;
  margin: 20px 0;
}
.markdown-preview.markdown-preview ul,
.markdown-preview.markdown-preview ol {
  padding: 0 0 0.5em 1.5em;
}
.markdown-preview.markdown-preview ul > li,
.markdown-preview.markdown-preview ol > li {
  position: relative;
  list-style: none;
  margin: 5px 0;
}
.markdown-preview.markdown-preview ul > li::after {
  display: block;
  content: "";
  position: absolute;
  top: 0.5em;
  left: -1em;
  width: 6px;
  height: 6px;
  background-color: #33ad9d;
  border-radius: 100%;
}
.markdown-preview.markdown-preview ul ul li::after {
  display: block;
  content: "";
  position: absolute;
  top: 0.75em;
  left: -1em;
  width: 6px;
  height: 2px;
  background-color: #33ad9d;
}
.markdown-preview.markdown-preview ul ul ul li::after {
  display: block;
  content: "";
  position: absolute;
  top: 0.5em;
  left: -1em;
  width: 6px;
  height: 6px;
  border-right: 2px solid #33ad9d;
  border-bottom: 2px solid #33ad9d;
  background-color: inherit;
  border-radius: 0;
  -webkit-transform: rotate(-45deg);
  transform: rotate(-45deg);
}
.markdown-preview.markdown-preview ul.arrow > li::after {
  display: block;
  content: "";
  position: absolute;
  top: 0.5em;
  left: -1em;
  width: 6px;
  height: 6px;
  border-right: 2px solid #33ad9d;
  border-bottom: 2px solid #33ad9d;
  background-color: inherit;
  border-radius: 0;
  -webkit-transform: rotate(-45deg);
  transform: rotate(-45deg);
}
.markdown-preview.markdown-preview ul.check > li::after {
  display: block;
  content: "";
  position: absolute;
  top: 0.5em;
  left: -1em;
  width: 8px;
  height: 3px;
  border-left: 2px solid #33ad9d;
  border-bottom: 2px solid #33ad9d;
  background-color: inherit;
  border-radius: 0;
  -webkit-transform: rotate(-45deg);
  transform: rotate(-45deg);
}
.markdown-preview.markdown-preview ol > li {
  counter-increment: li;
}
.markdown-preview.markdown-preview ol > li::before {
  content: counter(li);
  display: block;
  position: absolute;
  top: 0.3em;
  left: -1em;
  color: #33ad9d;
  font-size: 14px;
  line-height: 1;
  font-weight: bold;
}
.markdown-preview.markdown-preview table {
  border-collapse: collapse;
  line-height: 1.5;
  margin: 10px 0;
  width: 100%;
}
.markdown-preview.markdown-preview table th {
  padding: 10px;
  font-size: 12px;
  font-weight: bold;
  vertical-align: top;
  text-align: left;
  background: #c6cbca;
  border: 1px solid #b7bdbc !important;
}
.markdown-preview.markdown-preview table td {
  font-size: 12px;
}
.markdown-preview.markdown-preview table.stripe tr:nth-child(even) {
  background: #dcdfdf;
}
.markdown-preview.markdown-preview table.dark th {
  color: #e5e8e8;
  background: #272b2b;
}
.markdown-preview.markdown-preview .box_gray {
  background: #dcdfdf;
  border: 2px solid #b8bfbe;
  border-radius: 10px;
  margin: 20px 0;
  padding: 1em;
}
.markdown-preview.markdown-preview .box_pink {
  background: #e7d5d5;
  border: 2px solid #d47e7e;
  border-radius: 10px;
  margin: 20px 0;
  padding: 1em;
}
.markdown-preview.markdown-preview .box_pink ul,
.markdown-preview.markdown-preview .box_pink ol {
  padding: 0 0 0 1.5em;
}
.markdown-preview.markdown-preview .box_pink ol > li::before {
  content: counter(li);
  display: block;
  position: absolute;
  top: 0.3em;
  left: -1em;
  color: #d47e7e;
  line-height: 1;
  font-weight: bold;
}
.markdown-preview.markdown-preview .box_pink ul > li::after {
  display: block;
  content: "";
  position: absolute;
  top: 0.5em;
  left: -1em;
  width: 6px;
  height: 6px;
  background-color: #d47e7e;
  border-radius: 100%;
}
.markdown-preview.markdown-preview .box_gray ul,
.markdown-preview.markdown-preview .box_gray ol {
  padding: 0 0 0 1.5em;
}
.markdown-preview.markdown-preview .box_gray ol > li::before {
  content: counter(li);
  display: block;
  position: absolute;
  top: 0.3em;
  left: -1em;
  color: #b8bfbe;
  line-height: 1;
  font-weight: bold;
}
.markdown-preview.markdown-preview .box_gray ul > li::after {
  display: block;
  content: "";
  position: absolute;
  top: 0.5em;
  left: -1em;
  width: 6px;
  height: 6px;
  background-color: #b8bfbe;
  border-radius: 100%;
}

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h2 id="uc01-画像と結果の文字列のペアをまとめて登録し-学習を実行する">UC01 画像と結果の文字列のペアをまとめて登録し、学習を実行する </h2>
<h3 id="1-ローカルから-csv-ファイルを-s3-にアップロードするバッチスクリプト">1. ローカルから CSV ファイルを S3 にアップロードするバッチスクリプト </h3>
<p>まず、ローカルから CSV ファイルを S3 にアップロードするバッチスクリプトを作成します。</p>
<h4 id="upload_to_s3bat">upload_to_s3.bat </h4>
<pre data-role="codeBlock" data-info="batch" class="language-batch batch"><code><span class="token operator">@</span><span class="token command"><span class="token keyword keyword-echo">echo</span> off</span>

<span class="token command"><span class="token keyword keyword-setlocal">setlocal</span></span>

<span class="token comment">REM S3バケット名とCSVファイルのパスを設定</span>

<span class="token command"><span class="token keyword keyword-set">set</span> <span class="token variable">AWS_BUCKET</span><span class="token operator">=</span>ogiri<span class="token operator">-</span>training<span class="token operator">-</span>data<span class="token operator">-</span>bucket</span>

<span class="token command"><span class="token keyword keyword-set">set</span> <span class="token variable">CSV_FILE</span><span class="token operator">=</span>path\to\your\train<span class="token operator">_</span>data.csv</span>

<span class="token comment">REM CSVファイルをS3にアップロード</span>

<span class="token command"><span class="token keyword keyword-aws">aws</span> s3 cp <span class="token variable">%CSV_FILE%</span> s3://<span class="token variable">%AWS_BUCKET%</span>/</span>

<span class="token command"><span class="token keyword keyword-endlocal">endlocal</span></span>

</code></pre><h3 id="2-iam-ポリシーの作成">2. IAM ポリシーの作成 </h3>
<h4 id="21-トレーニングジョブ開始する-lambda-用のポリシーの作成">2.1. トレーニングジョブ開始する Lambda 用のポリシーの作成 </h4>
<h5 id="手順">手順: </h5>
<ol>
<li><strong>AWS マネジメントコンソール</strong>にログインし、<strong>IAM</strong>ダッシュボードに移動します。</li>
<li>左側のメニューから「<strong>ポリシー</strong>」を選択し、「<strong>ポリシーを作成</strong>」ボタンをクリックします。</li>
<li><strong>JSON</strong>タブを選択し、以下のポリシーを貼り付けます:</li>
</ol>
<details><summary>詳細を開く</summary>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"s3:PutObject"</span><span class="token punctuation">,</span> <span class="token string">"s3:GetObject"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:s3:::ogiri-training-data-bucket/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"dynamodb:GetItem"</span><span class="token punctuation">,</span> <span class="token string">"dynamodb:PutItem"</span><span class="token punctuation">,</span> <span class="token string">"dynamodb:PutItem"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:dynamodb:ap-northeast-1:765231401377:table/OgiriTrainingDataTable"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"rekognition:DetectLabels"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"sagemaker:CreateTrainingJob"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"logs:CreateLogGroup"</span><span class="token punctuation">,</span> <span class="token string">"logs:CreateLogStream"</span><span class="token punctuation">,</span> <span class="token string">"logs:PutLogEvents"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:logs:ap-northeast-1:765231401377:log-group:/aws/lambda/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></details>
<ol start="4">
<li>「<strong>次のステップ: タグ</strong>」をクリックし、任意のタグを追加します（省略可能）。</li>
<li>「<strong>次のステップ: 確認</strong>」をクリックし、ポリシーに名前（例: <code>LambdaStartOgiriTrainingJobPolicy</code>）と説明を入力して「<strong>ポリシーの作成</strong>」をクリックします。</li>
</ol>
<h4 id="22-トレーニングジョブ終了後の-lambda-用のポリシーの作成">2.2. トレーニングジョブ終了後の Lambda 用のポリシーの作成 </h4>
<h5 id="手順-1">手順: </h5>
<ol>
<li><a href="#21-%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E3%82%B8%E3%83%A7%E3%83%96%E9%96%8B%E5%A7%8B%E3%81%99%E3%82%8Blambda%E7%94%A8%E3%81%AE%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90">2.1</a>同様の手順で以下のポリシー（<code>LambdaEndOgiriTrainingJobRole</code>）を作成する</li>
</ol>
<details><summary>詳細を開く</summary>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"sagemaker:CreateModel"</span><span class="token punctuation">,</span>
                <span class="token string">"sagemaker:CreateEndpointConfig"</span><span class="token punctuation">,</span>
                <span class="token string">"sagemaker:CreateEndpoint"</span><span class="token punctuation">,</span>
                <span class="token string">"sagemaker:DescribeTrainingJob"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"logs:CreateLogGroup"</span><span class="token punctuation">,</span> <span class="token string">"logs:CreateLogStream"</span><span class="token punctuation">,</span> <span class="token string">"logs:PutLogEvents"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:logs:ap-northeast-1:765231401377:log-group:/aws/lambda/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></details>
<h4 id="23-トレーニングジョブ開始する-sagemaker-用のポリシーの作成">2.3. トレーニングジョブ開始する SageMaker 用のポリシーの作成 </h4>
<h5 id="手順-2">手順: </h5>
<ol>
<li><a href="#21-%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E3%82%B8%E3%83%A7%E3%83%96%E9%96%8B%E5%A7%8B%E3%81%99%E3%82%8Blambda%E7%94%A8%E3%81%AE%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90">2.1</a>同様の手順で以下のポリシー（<code>SageMakerStartOgiriTrainingJobPolicy</code>）を作成する</li>
</ol>
<details><summary>詳細を開く</summary>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"sagemaker:CreateTrainingJob"</span><span class="token punctuation">,</span> <span class="token string">"sagemaker:DescribeTrainingJob"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span> <span class="token string">"s3:PutObject"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:s3:::ogiri-training-data-bucket/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"dynamodb:Scan"</span><span class="token punctuation">,</span> <span class="token string">"dynamodb:GetItem"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:dynamodb:ap-northeast-1:765231401377:table/OgiriTrainingDataTable"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"logs:CreateLogGroup"</span><span class="token punctuation">,</span> <span class="token string">"logs:CreateLogStream"</span><span class="token punctuation">,</span> <span class="token string">"logs:PutLogEvents"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:logs:ap-northeast-1:765231401377:log-group:/aws/sagemaker/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"cloudwatch:PutMetricData"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></details>
<h4 id="24-トレーニングジョブ終了後の-sagemaker-用のポリシーの作成">2.4. トレーニングジョブ終了後の SageMaker 用のポリシーの作成 </h4>
<h5 id="手順-3">手順: </h5>
<ol>
<li><a href="#21-%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E3%82%B8%E3%83%A7%E3%83%96%E9%96%8B%E5%A7%8B%E3%81%99%E3%82%8Blambda%E7%94%A8%E3%81%AE%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90">2.1</a>同様の手順で以下のポリシー（<code>SageMakerEndOgiriTrainingJobPolicy</code>）を作成する</li>
</ol>
<details><summary>詳細を開く</summary>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:s3:::ogiri-training-data-bucket/output/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"sagemaker:CreateModel"</span><span class="token punctuation">,</span>
                <span class="token string">"sagemaker:CreateEndpointConfig"</span><span class="token punctuation">,</span>
                <span class="token string">"sagemaker:CreateEndpoint"</span>
                <span class="token string">"sagemaker:DescribeTrainingJob"</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"logs:CreateLogGroup"</span><span class="token punctuation">,</span> <span class="token string">"logs:CreateLogStream"</span><span class="token punctuation">,</span> <span class="token string">"logs:PutLogEvents"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:logs:ap-northeast-1:765231401377:log-group:/aws/sagemaker/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></details>
<h3 id="3-iam-ロールの作成">3. IAM ロールの作成 </h3>
<h4 id="31-トレーニングジョブ開始する-lambda-用のロールの作成">3.1. トレーニングジョブ開始する Lambda 用のロールの作成 </h4>
<h5 id="手順-4">手順: </h5>
<ol>
<li>IAM ダッシュボードの左側のメニューから「<strong>ロール</strong>」を選択し、「<strong>ロールを作成</strong>」ボタンをクリックします。</li>
<li>「<strong>信頼されたエンティティのタイプを選択</strong>」画面で「<strong>AWS サービス</strong>」を選択し、「<strong>Lambda</strong>」を選択します。「<strong>次のステップ</strong>」をクリックします。</li>
<li>先ほど作成したポリシー（<code>LambdaStartOgiriTrainingJobPolicy</code>）を検索し、選択して「<strong>次のステップ</strong>」をクリックします。</li>
<li>ロールに名前（例: <code>LambdaStartOgiriTrainingJobRole</code>）を付けて「<strong>ロールの作成</strong>」をクリックします。</li>
</ol>
<h4 id="32-トレーニングジョブ終了後の-lambda-用のロールの作成">3.2. トレーニングジョブ終了後の Lambda 用のロールの作成 </h4>
<h5 id="手順-5">手順: </h5>
<ol>
<li><a href="#31-%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E3%82%B8%E3%83%A7%E3%83%96%E9%96%8B%E5%A7%8B%E3%81%99%E3%82%8Blambda%E7%94%A8%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90">3.1</a>と同様の手順で以下の名前とポリシーのロールを作成する
<ul>
<li>ポリシー名: <code>LambdaEndOgiriTrainingJobPolicy</code></li>
<li>ロール名: <code>LambdaEndOgiriTrainingJobRole</code></li>
</ul>
</li>
</ol>
<h4 id="33-トレーニングジョブ開始する-sagemaker-用のロールの作成">3.3. トレーニングジョブ開始する SageMaker 用のロールの作成 </h4>
<h5 id="手順-6">手順: </h5>
<ol>
<li><a href="#31-%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E3%82%B8%E3%83%A7%E3%83%96%E9%96%8B%E5%A7%8B%E3%81%99%E3%82%8Blambda%E7%94%A8%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90">3.1</a>と同様の手順で以下の名前とポリシーのロールを作成する
<ul>
<li>ポリシー名: <code>SageMakerStartOgiriTrainingJobPolicy</code></li>
<li>ロール名: <code>SageMakerStartOgiriTrainingJobRole</code></li>
</ul>
</li>
</ol>
<h4 id="34-トレーニングジョブ終了後の-sagemaker-用のロールの作成">3.4. トレーニングジョブ終了後の SageMaker 用のロールの作成 </h4>
<h5 id="手順-7">手順: </h5>
<ol>
<li><a href="#31-%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E3%82%B8%E3%83%A7%E3%83%96%E9%96%8B%E5%A7%8B%E3%81%99%E3%82%8Blambda%E7%94%A8%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90">3.1</a>と同様の手順で以下の名前とポリシーのロールを作成する
<ul>
<li>ポリシー名: <code>SageMakerEndOgiriTrainingJobPolicy</code></li>
<li>ロール名: <code>SageMakerEndOgiriTrainingJobRole</code></li>
</ul>
</li>
</ol>
<h3 id="4-iam-ユーザーに権限を追加">4. IAM ユーザーに権限を追加 </h3>
<h4 id="41-iam-ユーザーに必要なポリシーを作成">4.1. IAM ユーザーに必要なポリシーを作成 </h4>
<ol>
<li><strong>AWS マネジメントコンソール</strong>にログインし、<strong>IAM</strong>ダッシュボードに移動します。</li>
<li>左側のメニューから「<strong>ポリシー</strong>」を選択し、「<strong>ポリシーを作成</strong>」ボタンをクリックします。</li>
<li><strong>JSON</strong>タブを選択し、以下のポリシーを貼り付けます:</li>
</ol>
<details><summary>詳細を開く</summary>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
  <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"s3:ListBucket"</span><span class="token punctuation">,</span> <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span> <span class="token string">"s3:PutObject"</span><span class="token punctuation">,</span> <span class="token string">"s3:DeleteObject"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"arn:aws:s3:::ogiri-training-data-bucket"</span><span class="token punctuation">,</span>
        <span class="token string">"arn:aws:s3:::ogiri-training-data-bucket/*"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"rekognition:DetectLabels"</span><span class="token punctuation">,</span>
      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"dynamodb:PutItem"</span><span class="token punctuation">,</span>
        <span class="token string">"dynamodb:GetItem"</span><span class="token punctuation">,</span>
        <span class="token string">"dynamodb:UpdateItem"</span><span class="token punctuation">,</span>
        <span class="token string">"dynamodb:Scan"</span><span class="token punctuation">,</span>
        <span class="token string">"dynamodb:Query"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:dynamodb:ap-northeast-1:765231401377:table/OgiriTrainingDataTable"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"sagemaker:CreateTrainingJob"</span><span class="token punctuation">,</span>
        <span class="token string">"sagemaker:DescribeTrainingJob"</span><span class="token punctuation">,</span>
        <span class="token string">"sagemaker:CreateModel"</span><span class="token punctuation">,</span>
        <span class="token string">"sagemaker:CreateEndpointConfig"</span><span class="token punctuation">,</span>
        <span class="token string">"sagemaker:CreateEndpoint"</span><span class="token punctuation">,</span>
        <span class="token string">"sagemaker:InvokeEndpoint"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"logs:CreateLogGroup"</span><span class="token punctuation">,</span> <span class="token string">"logs:CreateLogStream"</span><span class="token punctuation">,</span> <span class="token string">"logs:PutLogEvents"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:logs:ap-northeast-1:765231401377:log-group:/aws/lambda/*"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"lambda:InvokeFunction"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:lambda:ap-northeast-1:765231401377:function:StartOgiriTrainingJob"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></details>
<ol start="4">
<li>「<strong>次のステップ: タグ</strong>」をクリックし、任意のタグを追加します（省略可能）。</li>
<li>「<strong>次のステップ: 確認</strong>」をクリックし、ポリシーに名前（例: <code>UserOgiriTrainingJobPolicy</code>）と説明を入力して「<strong>ポリシーの作成</strong>」をクリックします。</li>
</ol>
<h4 id="42-iam-ユーザーに必要なポリシーを追加">4.2. IAM ユーザーに必要なポリシーを追加 </h4>
<ol>
<li>左側のメニューから「<strong>ユーザー</strong>」を選択し、作成済みのユーザのリンクをクリックします。</li>
<li>「<strong>許可</strong>」タブの「<strong>許可ポリシー</strong>」画面で「<strong>許可を追加</strong>」をクリックし、「<strong>ポリシーを直接アタッチする</strong>」を選択します。</li>
<li>先ほど作成したポリシー（<code>UserOgiriTrainingJobPolicy</code>）を検索し、選択して「<strong>次へ</strong>」をクリックし、「<strong>許可を追加</strong>」をクリックします。</li>
</ol>
<h3 id="5-s3-バケットの設定">5. S3 バケットの設定 </h3>
<h4 id="手順-8">手順: </h4>
<ol>
<li><strong>S3</strong>ダッシュボードに移動し、デフォルトの設定で<code>ogiri-training-data-bucket</code>を作成します。</li>
<li>バケットの「<strong>プロパティ</strong>」タブを開き、下にスクロールして「<strong>イベント通知</strong>」セクションを見つけます。</li>
<li>「<strong>イベント通知を追加</strong>」をクリックし、名前を入力します（例: <code>OgiriCSVUploadEvent</code>）。</li>
<li>「<strong>イベントタイプ</strong>」で「<strong>すべてのオブジェクト作成イベント</strong>」を選択します。</li>
<li>「<strong>プレフィックス</strong>」と「<strong>サフィックス</strong>」を設定して、CSV ファイルに限定します（例: <code>サフィックス: .csv</code>）。</li>
<li>「<strong>Lambda 関数</strong>」セクションで、「<strong>Lambda 関数の選択</strong>」から先ほど作成した関数（<code>StartOgiriTrainingJob</code>）を選択します。</li>
<li>「<strong>保存</strong>」をクリックします。</li>
</ol>
<h3 id="6-dynamodb-テーブルの作成">6. DynamoDB テーブルの作成 </h3>
<h4 id="手順-9">手順: </h4>
<ol>
<li><strong>DynamoDB</strong>ダッシュボードに移動し、「<strong>テーブルを作成</strong>」をクリックします。</li>
<li>テーブル名を入力します（例: <code>OgiriTrainingDataTable</code>）。</li>
<li><strong>プライマリキー</strong>として、以下を設定します:
<ul>
<li><strong>パーティションキー</strong>: <code>ImageKey</code>（タイプ：文字列）</li>
<li><strong>ソートキー</strong>: <code>ExpectedResult</code>（タイプ：文字列）</li>
</ul>
</li>
<li><strong>その他の設定</strong>の<strong>プロビジョニングモード</strong>は「オンデマンドキャパシティーモード」を選択します<br>
（または、必要に応じてプロビジョンドキャパシティーモードを選択し、読み取り/書き込みキャパシティーユニットを設定します）。</li>
<li>「<strong>テーブルの作成</strong>」をクリックします。</li>
</ol>
<table>
<thead>
<tr>
<th>設定項目</th>
<th>設定値</th>
</tr>
</thead>
<tbody>
<tr>
<td>テーブル名</td>
<td>OgiriTrainingDataTable</td>
</tr>
<tr>
<td>パーティションキー</td>
<td>ImageKey（タイプ：文字列）</td>
</tr>
<tr>
<td>ソートキー</td>
<td>ExpectedResult（タイプ：文字列）</td>
</tr>
<tr>
<td>プロビジョニングモード</td>
<td>オンデマンドキャパシティーモード</td>
</tr>
</tbody>
</table>
<h3 id="7-sagemaker-の設定">7. SageMaker の設定 </h3>
<h4 id="71-トレーニングスクリプトの準備">7.1. トレーニングスクリプトの準備 </h4>
<p><code>training_script.py</code>を作成する</p>
<details><summary>詳細をクリック</summary>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> logging
<span class="token keyword keyword-import">import</span> boto3
<span class="token keyword keyword-import">import</span> json
<span class="token keyword keyword-import">import</span> os
<span class="token keyword keyword-import">import</span> torch
<span class="token keyword keyword-import">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword keyword-as">as</span> nn
<span class="token keyword keyword-import">import</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword keyword-as">as</span> models
<span class="token keyword keyword-import">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword keyword-as">as</span> transforms
<span class="token keyword keyword-from">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword keyword-import">import</span> Dataset<span class="token punctuation">,</span> DataLoader
<span class="token keyword keyword-from">from</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>rnn <span class="token keyword keyword-import">import</span> pack_padded_sequence
<span class="token keyword keyword-from">from</span> PIL <span class="token keyword keyword-import">import</span> Image
<span class="token keyword keyword-from">from</span> io <span class="token keyword keyword-import">import</span> BytesIO
<span class="token keyword keyword-import">import</span> requests
<span class="token keyword keyword-import">import</span> argparse  <span class="token comment"># 追加</span>

<span class="token comment"># CloudWatch Logsの設定</span>
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token comment"># 定数の定義</span>
EMBEDDING_DIM <span class="token operator">=</span> <span class="token number">256</span>
HIDDEN_DIM <span class="token operator">=</span> <span class="token number">512</span>
VOCAB_SIZE <span class="token operator">=</span> <span class="token number">5000</span>  <span class="token comment"># 語彙サイズは必要に応じて調整</span>
MAX_SEQ_LENGTH <span class="token operator">=</span> <span class="token number">20</span>

<span class="token comment"># 画像特徴抽出モデル（ResNet）にランダム性を追加</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">EncoderCNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> embed_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>EncoderCNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        resnet <span class="token operator">=</span> models<span class="token punctuation">.</span>resnet50<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># ResNetモデルの読み込み</span>
        modules <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>resnet<span class="token punctuation">.</span>children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 最後の全結合層を除去</span>
        self<span class="token punctuation">.</span>resnet <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>modules<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>linear <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>resnet<span class="token punctuation">.</span>fc<span class="token punctuation">.</span>in_features<span class="token punctuation">,</span> embed_size<span class="token punctuation">)</span>  <span class="token comment"># 埋め込み層</span>
        self<span class="token punctuation">.</span>bn <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span>embed_size<span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>  <span class="token comment"># バッチ正規化層</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>  <span class="token comment"># Dropout層でランダム性を追加</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> images<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-with">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 勾配計算をしない</span>
            features <span class="token operator">=</span> self<span class="token punctuation">.</span>resnet<span class="token punctuation">(</span>images<span class="token punctuation">)</span>  <span class="token comment"># ResNetで特徴抽出</span>
        features <span class="token operator">=</span> features<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        features <span class="token operator">=</span> self<span class="token punctuation">.</span>bn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 埋め込み層とバッチ正規化</span>
        features <span class="token operator">=</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>features<span class="token punctuation">)</span>  <span class="token comment"># Dropoutを適用</span>
        <span class="token keyword keyword-return">return</span> features

<span class="token comment"># キャプション生成モデル（LSTM）</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">DecoderRNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> embed_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span> vocab_size<span class="token punctuation">,</span> num_layers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DecoderRNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>embed <span class="token operator">=</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">(</span>vocab_size<span class="token punctuation">,</span> embed_size<span class="token punctuation">)</span>  <span class="token comment"># 埋め込み層</span>
        self<span class="token punctuation">.</span>lstm <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>embed_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span> batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># LSTM層</span>
        self<span class="token punctuation">.</span>linear <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_size<span class="token punctuation">,</span> vocab_size<span class="token punctuation">)</span>  <span class="token comment"># 全結合層</span>
        self<span class="token punctuation">.</span>max_seg_length <span class="token operator">=</span> MAX_SEQ_LENGTH  <span class="token comment"># 最大シーケンス長</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> features<span class="token punctuation">,</span> captions<span class="token punctuation">)</span><span class="token punctuation">:</span>
        embeddings <span class="token operator">=</span> self<span class="token punctuation">.</span>embed<span class="token punctuation">(</span>captions<span class="token punctuation">)</span>  <span class="token comment"># キャプションを埋め込みに変換</span>
        embeddings <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> embeddings<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 特徴とキャプションを結合</span>
        hiddens<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm<span class="token punctuation">(</span>embeddings<span class="token punctuation">)</span>  <span class="token comment"># LSTMで処理</span>
        outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>hiddens<span class="token punctuation">)</span>  <span class="token comment"># 全結合層で出力</span>
        <span class="token keyword keyword-return">return</span> outputs

    <span class="token keyword keyword-def">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> features<span class="token punctuation">,</span> states<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sampled_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        inputs <span class="token operator">=</span> features<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>max_seg_length<span class="token punctuation">)</span><span class="token punctuation">:</span>
            hiddens<span class="token punctuation">,</span> states <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> states<span class="token punctuation">)</span>  <span class="token comment"># LSTMで処理</span>
            outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>hiddens<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 全結合層で出力</span>
            _<span class="token punctuation">,</span> predicted <span class="token operator">=</span> outputs<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 最も確率の高い単語を選択</span>
            sampled_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span>predicted<span class="token punctuation">)</span>
            inputs <span class="token operator">=</span> self<span class="token punctuation">.</span>embed<span class="token punctuation">(</span>predicted<span class="token punctuation">)</span>  <span class="token comment"># 埋め込みに変換</span>
            inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 次のLSTM入力の形に変換</span>
        sampled_ids <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>sampled_ids<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># サンプルIDをスタック</span>
        <span class="token keyword keyword-return">return</span> sampled_ids

<span class="token comment"># データセットクラスの定義</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">OgiriDataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dynamodb_table_name<span class="token punctuation">,</span> s3_client<span class="token punctuation">,</span> dynamodb_client<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>dynamodb_table_name <span class="token operator">=</span> dynamodb_table_name
        self<span class="token punctuation">.</span>s3_client <span class="token operator">=</span> s3_client
        self<span class="token punctuation">.</span>dynamodb_client <span class="token operator">=</span> dynamodb_client
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_data_from_dynamodb<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># DynamoDBからデータをロード</span>
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
            transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 画像サイズの変更</span>
            transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># テンソルに変換</span>
            transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 正規化</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"DynamoDBから</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">個のデータをロードしました。"</span></span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_load_data_from_dynamodb</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        paginator <span class="token operator">=</span> self<span class="token punctuation">.</span>dynamodb_client<span class="token punctuation">.</span>get_paginator<span class="token punctuation">(</span><span class="token string">'scan'</span><span class="token punctuation">)</span>
        response_iterator <span class="token operator">=</span> paginator<span class="token punctuation">.</span>paginate<span class="token punctuation">(</span>TableName<span class="token operator">=</span>self<span class="token punctuation">.</span>dynamodb_table_name<span class="token punctuation">)</span>
        data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-for">for</span> page <span class="token keyword keyword-in">in</span> response_iterator<span class="token punctuation">:</span>
            data<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>page<span class="token punctuation">[</span><span class="token string">'Items'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> data

    <span class="token keyword keyword-def">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        item <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        image_url <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">'ImageUrl'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'S'</span><span class="token punctuation">]</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>image_url<span class="token punctuation">)</span>  <span class="token comment"># 画像をダウンロード</span>
        image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>BytesIO<span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
        image <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span>  <span class="token comment"># 画像を変換</span>
        expected_result <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">'ExpectedResult'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'S'</span><span class="token punctuation">]</span>
        labels <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">'Labels'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'SS'</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-return">return</span> image<span class="token punctuation">,</span> expected_result<span class="token punctuation">,</span> labels

<span class="token comment"># トレーニング関数</span>
<span class="token keyword keyword-def">def</span> <span class="token function">train</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dynamodb_table_name <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'DYNAMODB_TABLE_NAME'</span><span class="token punctuation">]</span>
    s3_client <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">'s3'</span><span class="token punctuation">)</span>
    dynamodb_client <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">'dynamodb'</span><span class="token punctuation">)</span>

    batch_size <span class="token operator">=</span> args<span class="token punctuation">.</span>batch_size
    num_epochs <span class="token operator">=</span> args<span class="token punctuation">.</span>epochs
    learning_rate <span class="token operator">=</span> args<span class="token punctuation">.</span>learning_rate

    dataset <span class="token operator">=</span> OgiriDataset<span class="token punctuation">(</span>dynamodb_table_name<span class="token punctuation">,</span> s3_client<span class="token punctuation">,</span> dynamodb_client<span class="token punctuation">)</span>
    dataloader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># データローダーの設定</span>

    <span class="token comment"># モデルの定義</span>
    encoder <span class="token operator">=</span> EncoderCNN<span class="token punctuation">(</span>EMBEDDING_DIM<span class="token punctuation">)</span>
    decoder <span class="token operator">=</span> DecoderRNN<span class="token punctuation">(</span>EMBEDDING_DIM<span class="token punctuation">,</span> HIDDEN_DIM<span class="token punctuation">,</span> VOCAB_SIZE<span class="token punctuation">)</span>

    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword keyword-if">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-else">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>
    encoder<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    decoder<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    <span class="token comment"># 最適化関数と損失関数の定義</span>
    criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    params <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>decoder<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">list</span><span class="token punctuation">(</span>encoder<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">list</span><span class="token punctuation">(</span>encoder<span class="token punctuation">.</span>bn<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>params<span class="token punctuation">,</span> lr<span class="token operator">=</span>learning_rate<span class="token punctuation">)</span>

    <span class="token comment"># トレーニング開始</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"トレーニングを開始します"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> epoch <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Epoch </span><span class="token interpolation"><span class="token punctuation">{</span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>num_epochs<span class="token punctuation">}</span></span><span class="token string"> started"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>images<span class="token punctuation">,</span> captions<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            images <span class="token operator">=</span> images<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            captions <span class="token operator">=</span> captions<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

            <span class="token comment"># 前方伝播</span>
            features <span class="token operator">=</span> encoder<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
            outputs <span class="token operator">=</span> decoder<span class="token punctuation">(</span>features<span class="token punctuation">,</span> captions<span class="token punctuation">)</span>
            targets <span class="token operator">=</span> pack_padded_sequence<span class="token punctuation">(</span>captions<span class="token punctuation">,</span> lengths<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>caption<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> caption <span class="token keyword keyword-in">in</span> captions<span class="token punctuation">]</span><span class="token punctuation">,</span> batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> outputs<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targets<span class="token punctuation">)</span>

            <span class="token comment"># 逆伝播と最適化</span>
            decoder<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            encoder<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword keyword-if">if</span> i <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Epoch [</span><span class="token interpolation"><span class="token punctuation">{</span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>num_epochs<span class="token punctuation">}</span></span><span class="token string">], Step [</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">], Loss: </span><span class="token interpolation"><span class="token punctuation">{</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># モデルの保存</span>
    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>encoder<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'/opt/ml/model/encoder.ckpt'</span><span class="token punctuation">)</span>
    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>decoder<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'/opt/ml/model/decoder.ckpt'</span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"トレーニングが完了し、モデルを保存しました"</span><span class="token punctuation">)</span>

<span class="token keyword keyword-if">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--batch_size'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--epochs'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--learning_rate'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    train<span class="token punctuation">(</span>args<span class="token punctuation">)</span>
</code></pre></details>
<h4 id="72-トレーニングスクリプトを-s3-にアップロード">7.2. トレーニングスクリプトを S3 にアップロード </h4>
<ol>
<li>AWS マネジメントコンソールで「S3」サービスに移動します。</li>
<li>アップロードしたいバケット（例: <code>ogiri-training-data-bucket</code>）を選択します。</li>
<li>「オブジェクトをアップロード」をクリックし、<code>training_script.py</code>をアップロードします。</li>
</ol>
<h3 id="8-トレーニングジョブ開始する-lambda-関数の作成">8. トレーニングジョブ開始する Lambda 関数の作成 </h3>
<ol>
<li>
<p><strong>Lambda 関数の作成</strong>：</p>
<ul>
<li>Lambda ダッシュボードに移動し、「関数の作成」をクリックします。</li>
<li>「一から作成」を選択し、関数名（例: <code>StartOgiriTrainingJob</code>）を入力し、ランタイムを Python 3.8 に設定します。</li>
<li>実行ロールには「既存のロールを使用する」を選択し、<code>LambdaStartOgiriTrainingJobRole</code>を選択します。</li>
<li>「関数の作成」をクリックします。</li>
</ul>
</li>
<li>
<p><strong>Lambda 関数にコードを追加</strong>：</p>
</li>
</ol>
<details><summary>詳細をクリック</summary>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> json
<span class="token keyword keyword-import">import</span> boto3
<span class="token keyword keyword-import">import</span> csv
<span class="token keyword keyword-import">import</span> requests
<span class="token keyword keyword-from">from</span> botocore<span class="token punctuation">.</span>exceptions <span class="token keyword keyword-import">import</span> NoCredentialsError<span class="token punctuation">,</span> ClientError
<span class="token keyword keyword-import">import</span> logging

<span class="token comment"># CloudWatch Logsの設定</span>
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

s3 <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">'s3'</span><span class="token punctuation">)</span>
rekognition <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">'rekognition'</span><span class="token punctuation">)</span>
dynamodb <span class="token operator">=</span> boto3<span class="token punctuation">.</span>resource<span class="token punctuation">(</span><span class="token string">'dynamodb'</span><span class="token punctuation">)</span>
sagemaker <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">'sagemaker'</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">lambda_handler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token comment"># イベントからバケット名とオブジェクトキーを取得</span>
        bucket <span class="token operator">=</span> event<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'bucket'</span><span class="token punctuation">)</span>
        key <span class="token operator">=</span> event<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> bucket <span class="token keyword keyword-or">or</span> <span class="token keyword keyword-not">not</span> key<span class="token punctuation">:</span>
            <span class="token keyword keyword-raise">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"バケットとキーはイベントで指定してください。"</span><span class="token punctuation">)</span>

        <span class="token comment"># S3からCSVファイルを取得</span>
        csv_file <span class="token operator">=</span> s3<span class="token punctuation">.</span>get_object<span class="token punctuation">(</span>Bucket<span class="token operator">=</span>bucket<span class="token punctuation">,</span> Key<span class="token operator">=</span>key<span class="token punctuation">)</span>
        csv_content <span class="token operator">=</span> csv_file<span class="token punctuation">[</span><span class="token string">'Body'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
        csv_reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>csv_content<span class="token punctuation">)</span>

        <span class="token comment"># DynamoDBに学習用のデータを登録する</span>
        table <span class="token operator">=</span> dynamodb<span class="token punctuation">.</span>Table<span class="token punctuation">(</span><span class="token string">'OgiriTrainingDataTable'</span><span class="token punctuation">)</span>

        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"学習用のデータの登録を開始します。"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> row <span class="token keyword keyword-in">in</span> csv_reader<span class="token punctuation">:</span>
            image_url<span class="token punctuation">,</span> expected_result <span class="token operator">=</span> row

            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                image_name <span class="token operator">=</span> image_url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
                image_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"images/</span><span class="token interpolation"><span class="token punctuation">{</span>image_name<span class="token punctuation">}</span></span><span class="token string">"</span></span>  <span class="token comment"># images ディレクトリに配置</span>

                <span class="token comment"># DynamoDBに既にデータが存在するか確認</span>
                response <span class="token operator">=</span> table<span class="token punctuation">.</span>get_item<span class="token punctuation">(</span>Key<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'ImageKey'</span><span class="token punctuation">:</span> image_key<span class="token punctuation">,</span> <span class="token string">'ExpectedResult'</span><span class="token punctuation">:</span> expected_result<span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-if">if</span> <span class="token string">'Item'</span> <span class="token keyword keyword-in">in</span> response<span class="token punctuation">:</span>
                    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>image_url<span class="token punctuation">}</span></span><span class="token string">は既に処理されています。"</span></span><span class="token punctuation">)</span>
                    <span class="token keyword keyword-continue">continue</span>

                <span class="token comment"># Rekognitionを使用して画像を分析する</span>
                rekognition_labels <span class="token operator">=</span> <span class="token boolean">None</span>

                <span class="token comment"># 同じ画像が存在するかを確認する</span>
                labels_response <span class="token operator">=</span> table<span class="token punctuation">.</span>query<span class="token punctuation">(</span>
                    KeyConditionExpression<span class="token operator">=</span>boto3<span class="token punctuation">.</span>dynamodb<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>Key<span class="token punctuation">(</span><span class="token string">'ImageKey'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>eq<span class="token punctuation">(</span>image_key<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>

                <span class="token comment"># S3のURLを生成</span>
                s3_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://</span><span class="token interpolation"><span class="token punctuation">{</span>bucket<span class="token punctuation">}</span></span><span class="token string">.s3.amazonaws.com/</span><span class="token interpolation"><span class="token punctuation">{</span>image_key<span class="token punctuation">}</span></span><span class="token string">"</span></span>

                <span class="token comment"># 同じ画像が存在する場合は、DynamoDBの分析結果を使用する</span>
                <span class="token keyword keyword-if">if</span> labels_response<span class="token punctuation">[</span><span class="token string">'Items'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    rekognition_labels <span class="token operator">=</span> labels_response<span class="token punctuation">[</span><span class="token string">'Items'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Labels'</span><span class="token punctuation">]</span>
                <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                    <span class="token comment"># 画像が存在しない場合は登録する</span>

                    <span class="token comment"># グローバルなURLから画像をダウンロード</span>
                    image_data <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>image_url<span class="token punctuation">)</span><span class="token punctuation">.</span>content

                    <span class="token comment"># ダウンロードした画像をS3にアップロード</span>
                    s3<span class="token punctuation">.</span>put_object<span class="token punctuation">(</span>Bucket<span class="token operator">=</span>bucket<span class="token punctuation">,</span> Key<span class="token operator">=</span>image_key<span class="token punctuation">,</span> Body<span class="token operator">=</span>image_data<span class="token punctuation">)</span>
                    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"S3に</span><span class="token interpolation"><span class="token punctuation">{</span>image_key<span class="token punctuation">}</span></span><span class="token string">を登録しました。"</span></span><span class="token punctuation">)</span>

                    <span class="token comment"># Rekognitionを使用して画像を分析</span>
                    rekognition_response <span class="token operator">=</span> rekognition<span class="token punctuation">.</span>detect_labels<span class="token punctuation">(</span>
                        Image<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'S3Object'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'Bucket'</span><span class="token punctuation">:</span> bucket<span class="token punctuation">,</span> <span class="token string">'Name'</span><span class="token punctuation">:</span> image_key<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        MaxLabels<span class="token operator">=</span><span class="token number">10</span>
                    <span class="token punctuation">)</span>
                    rekognition_labels <span class="token operator">=</span> <span class="token punctuation">[</span>label<span class="token punctuation">[</span><span class="token string">'Name'</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> label <span class="token keyword keyword-in">in</span> rekognition_response<span class="token punctuation">[</span><span class="token string">'Labels'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

                <span class="token comment"># DynamoDBに画像URLと期待結果を保存</span>
                table <span class="token operator">=</span> dynamodb<span class="token punctuation">.</span>Table<span class="token punctuation">(</span><span class="token string">'OgiriTrainingDataTable'</span><span class="token punctuation">)</span>
                table<span class="token punctuation">.</span>put_item<span class="token punctuation">(</span>
                    Item<span class="token operator">=</span><span class="token punctuation">{</span>
                        <span class="token string">'ImageKey'</span><span class="token punctuation">:</span> image_key<span class="token punctuation">,</span>
                        <span class="token string">'ExpectedResult'</span><span class="token punctuation">:</span> expected_result
                        <span class="token string">'ImageUrl'</span><span class="token punctuation">:</span> s3_url<span class="token punctuation">,</span>
                        <span class="token string">'Labels'</span><span class="token punctuation">:</span> labels<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">)</span>
                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>image_url<span class="token punctuation">}</span></span><span class="token string">をDBに登録しました。"</span></span><span class="token punctuation">)</span>

            <span class="token keyword keyword-except">except</span> requests<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>RequestException <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
                logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>image_url<span class="token punctuation">}</span></span><span class="token string">からの画像のダウロードに失敗しました: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-except">except</span> ClientError <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
                logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>image_url<span class="token punctuation">}</span></span><span class="token string">の登録に失敗しました: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># SageMakerトレーニングジョブの作成</span>
                <span class="token comment"># SageMakerトレーニングジョブの作成</span>
        training_job_name <span class="token operator">=</span> <span class="token string">'ogiri-training-job'</span>
        response <span class="token operator">=</span> sagemaker<span class="token punctuation">.</span>create_training_job<span class="token punctuation">(</span>
            TrainingJobName<span class="token operator">=</span>training_job_name<span class="token punctuation">,</span>
            HyperParameters<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">'batch_size'</span><span class="token punctuation">:</span> <span class="token string">'32'</span><span class="token punctuation">,</span>
                <span class="token string">'epochs'</span><span class="token punctuation">:</span> <span class="token string">'10'</span><span class="token punctuation">,</span>
                <span class="token string">'learning_rate'</span><span class="token punctuation">:</span> <span class="token string">'0.001'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            AlgorithmSpecification<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">'TrainingImage'</span><span class="token punctuation">:</span> <span class="token string">'763104351884.dkr.ecr.us-west-2.amazonaws.com/pytorch-training:1.6.0-cpu-py36-ubuntu16.04'</span><span class="token punctuation">,</span>
                <span class="token string">'MetricDefinitions'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span><span class="token string">'Name'</span><span class="token punctuation">:</span> <span class="token string">'validation:error'</span><span class="token punctuation">,</span> <span class="token string">'Regex'</span><span class="token punctuation">:</span> <span class="token string">'validation:error=(.*)'</span><span class="token punctuation">}</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">'TrainingInputMode'</span><span class="token punctuation">:</span> <span class="token string">'File'</span><span class="token punctuation">,</span>
                <span class="token string">'EnableSageMakerMetricsTimeSeries'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
                <span class="token string">'ScriptMode'</span><span class="token punctuation">:</span> <span class="token string">'SageMaker'</span><span class="token punctuation">,</span>
                <span class="token string">'TrainingScript'</span><span class="token punctuation">:</span> <span class="token string">'s3://ogiri-training-data-bucket/training_script.py'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            RoleArn<span class="token operator">=</span><span class="token string">'arn:aws:iam::765231401377:role/SageMakerStartOgiriTrainingJobRole'</span><span class="token punctuation">,</span>
            InputDataConfig<span class="token operator">=</span><span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">'ChannelName'</span><span class="token punctuation">:</span> <span class="token string">'training'</span><span class="token punctuation">,</span>
                    <span class="token string">'DataSource'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">'S3DataSource'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                            <span class="token string">'S3DataType'</span><span class="token punctuation">:</span> <span class="token string">'S3Prefix'</span><span class="token punctuation">,</span>
                            <span class="token string">'S3Uri'</span><span class="token punctuation">:</span> <span class="token string">'s3://ogiri-training-data-bucket/training_data.json'</span><span class="token punctuation">,</span>
                            <span class="token string">'S3DataDistributionType'</span><span class="token punctuation">:</span> <span class="token string">'FullyReplicated'</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">'ContentType'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
                    <span class="token string">'InputMode'</span><span class="token punctuation">:</span> <span class="token string">'File'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            OutputDataConfig<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">'S3OutputPath'</span><span class="token punctuation">:</span> <span class="token string">'s3://ogiri-training-data-bucket/output/'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            ResourceConfig<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">'InstanceType'</span><span class="token punctuation">:</span> <span class="token string">'ml.m5.large'</span><span class="token punctuation">,</span>
                <span class="token string">'InstanceCount'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string">'VolumeSizeInGB'</span><span class="token punctuation">:</span> <span class="token number">50</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            StoppingCondition<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">'MaxRuntimeInSeconds'</span><span class="token punctuation">:</span> <span class="token number">86400</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            Environment<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">'DYNAMODB_TABLE_NAME'</span><span class="token punctuation">:</span> <span class="token string">'OgiriTrainingDataTable'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>

        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"トレーニングジョブの開始に成功しました。"</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            <span class="token string">'statusCode'</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            <span class="token string">'body'</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token string">'Tトレーニングジョブの開始に成功しました。'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword keyword-except">except</span> NoCredentialsError<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"権限がないです。"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            <span class="token string">'statusCode'</span><span class="token punctuation">:</span> <span class="token number">403</span><span class="token punctuation">,</span>
            <span class="token string">'body'</span><span class="token punctuation">:</span> <span class="token string">'権限がないです。'</span>
        <span class="token punctuation">}</span>
    <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"予期せぬ例外: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            <span class="token string">'statusCode'</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
            <span class="token string">'body'</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"予期せぬ例外: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
</code></pre></details>
<ol>
<li><strong>テストイベントの設定</strong>：
<ul>
<li>「テスト」ボタンをクリックし、テストイベントを作成します。以下のような JSON を使用します：
<ul>
<li><a href="#10-%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E3%82%B8%E3%83%A7%E3%83%96%E7%B5%82%E4%BA%86%E5%BE%8C%E3%81%AElambda%E9%96%A2%E6%95%B0%E3%81%AE%E4%BD%9C%E6%88%90">トレーニングジョブ終了後の lambda 関数の作成</a>完了後にテストする</li>
</ul>
</li>
</ul>
</li>
</ol>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"bucket"</span><span class="token operator">:</span> <span class="token string">"ogiri-training-data-bucket"</span><span class="token punctuation">,</span>
  <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"train_data.csv"</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="9-cloudwatch-event-rule-を設定する">9. CloudWatch Event Rule を設定する </h3>
<ol>
<li>
<p><strong>CloudWatch Event ルールの作成</strong>：</p>
<ul>
<li>AWS マネジメントコンソールで「CloudWatch」サービスに移動します。</li>
<li>左側のメニューから「ルール」を選択し、「ルールの作成」をクリックします。</li>
</ul>
</li>
<li>
<p><strong>ルールの詳細の設定</strong>：</p>
<ul>
<li>イベントソースを「イベントパターン」に設定し、以下のイベントパターンを使用します：</li>
</ul>
</li>
</ol>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"source"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"aws.sagemaker"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"detail-type"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"SageMaker Training Job State Change"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"detail"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"TrainingJobName"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"ogiri-training-job"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"TrainingJobStatus"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Completed"</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ol start="3">
<li><strong>ターゲットの設定</strong>：
<ul>
<li>ターゲットに新しい Lambda 関数を選択します。関数名を（例：<code>EndOgiriTrainingJob</code>）とします。</li>
</ul>
</li>
</ol>
<h3 id="10-トレーニングジョブ終了後の-lambda-関数の作成">10. トレーニングジョブ終了後の Lambda 関数の作成 </h3>
<ol>
<li>
<p><strong>Lambda 関数の作成</strong>：</p>
<ul>
<li>Lambda ダッシュボードに移動し、「関数の作成」をクリックします。</li>
<li>「一から作成」を選択し、関数名（例: <code>EndOgiriTrainingJob</code>）を入力し、ランタイムを Python 3.8 に設定します。</li>
<li>実行ロールには「既存のロールを使用する」を選択し、<code>LambdaEndOgiriTrainingJobRole</code>を選択します。</li>
<li>「関数の作成」をクリックします。</li>
</ul>
</li>
<li>
<p><strong>Lambda 関数にコードを追加</strong>：</p>
<ul>
<li>作成した Lambda 関数に以下のコードを追加します。</li>
</ul>
</li>
</ol>
<details><summary>詳細をクリック</summary>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> json
<span class="token keyword keyword-import">import</span> boto3
<span class="token keyword keyword-import">import</span> logging

<span class="token comment"># CloudWatch Logsの設定</span>
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

sagemaker <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">'sagemaker'</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">lambda_handler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        training_job_name <span class="token operator">=</span> event<span class="token punctuation">[</span><span class="token string">'detail'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'TrainingJobName'</span><span class="token punctuation">]</span>

        <span class="token comment"># トレーニングジョブの完了を確認</span>
        <span class="token keyword keyword-if">if</span> event<span class="token punctuation">[</span><span class="token string">'detail'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'TrainingJobStatus'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'Completed'</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"トレーニングジョブ</span><span class="token interpolation"><span class="token punctuation">{</span>training_job_name<span class="token punctuation">}</span></span><span class="token string">が正常に完了しませんでした。"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
                <span class="token string">'statusCode'</span><span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
                <span class="token string">'body'</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token string">'トレーニングが正常に完了しませんでした。'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

        <span class="token comment"># モデルの作成</span>
        model_name <span class="token operator">=</span> <span class="token string">'ogiri-model'</span>
        sagemaker<span class="token punctuation">.</span>create_model<span class="token punctuation">(</span>
            ModelName<span class="token operator">=</span>model_name<span class="token punctuation">,</span>
            PrimaryContainer<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">'Image'</span><span class="token punctuation">:</span> <span class="token string">'763104351884.dkr.ecr.us-west-2.amazonaws.com/pytorch-inference:1.6.0-cpu-py36-ubuntu16.04'</span><span class="token punctuation">,</span>
                <span class="token string">'ModelDataUrl'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"s3://ogiri-training-data-bucket/output/</span><span class="token interpolation"><span class="token punctuation">{</span>training_job_name<span class="token punctuation">}</span></span><span class="token string">/output/model.tar.gz"</span></span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            ExecutionRoleArn<span class="token operator">=</span><span class="token string">'arn:aws:iam::765231401377:role/SageMakerEndOgiriTrainingJobRole'</span>
        <span class="token punctuation">)</span>

        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"モデルの作成に成功しました。"</span><span class="token punctuation">)</span>

        <span class="token comment"># エンドポイント構成の作成</span>
        endpoint_config_name <span class="token operator">=</span> <span class="token string">'ogiri-endpoint-config'</span>
        sagemaker<span class="token punctuation">.</span>create_endpoint_config<span class="token punctuation">(</span>
            EndpointConfigName<span class="token operator">=</span>endpoint_config_name<span class="token punctuation">,</span>
            ProductionVariants<span class="token operator">=</span><span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">'VariantName'</span><span class="token punctuation">:</span> <span class="token string">'AllTraffic'</span><span class="token punctuation">,</span>
                    <span class="token string">'ModelName'</span><span class="token punctuation">:</span> model_name<span class="token punctuation">,</span>
                    <span class="token string">'InstanceType'</span><span class="token punctuation">:</span> <span class="token string">'ml.m5.large'</span><span class="token punctuation">,</span>
                    <span class="token string">'InitialInstanceCount'</span><span class="token punctuation">:</span> <span class="token number">1</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span>

        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"エンドポイント構成の作成に成功しました。"</span><span class="token punctuation">)</span>

        <span class="token comment"># エンドポイントの作成</span>
        endpoint_name <span class="token operator">=</span> <span class="token string">'ogiri-endpoint'</span>
        sagemaker<span class="token punctuation">.</span>create_endpoint<span class="token punctuation">(</span>
            EndpointName<span class="token operator">=</span>endpoint_name<span class="token punctuation">,</span>
            EndpointConfigName<span class="token operator">=</span>endpoint_config_name
        <span class="token punctuation">)</span>

        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"エンドポイントの作成に成功しました。"</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            <span class="token string">'statusCode'</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            <span class="token string">'body'</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token string">'モデルとエンドポイントの作成成功しました。'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"予期せぬ例外: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            <span class="token string">'statusCode'</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
            <span class="token string">'body'</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"予期せぬ例外: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
</code></pre></details>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>